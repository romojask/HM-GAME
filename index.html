<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#070d18" />
  <title>HM GAME ‚Äî Snake</title>

  <style>
    :root{
      --bg:#070d18;
      --txt: rgba(255,255,255,.92);
      --shadow: rgba(0,0,0,.35);

      --padBase: rgba(240,240,240,.96);
      --padDark: rgba(22,24,30,.95);
      --A:#e43b3b;

      /* ‚úÖ 50/50 ŸÅÿπŸÑŸä */
      --vh: 1vh;

      /* ‚úÖ ÿ≥ŸÉŸäŸÑ ŸÑŸÑÿ£ÿ≤ÿ±ÿßÿ± (Ÿäÿ™ÿπÿØŸÑ ŸÖŸÜ JS ÿ≠ÿ≥ÿ® ÿßÿ±ÿ™ŸÅÿßÿπ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ) */
      --padScale: 1;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 900px at 70% 15%, #1b2a55, var(--bg));
      color: var(--txt);

      overflow:hidden;              /* ‚úÖ ŸÑÿß ÿ≥ŸÉÿ±ŸàŸÑ */
      overscroll-behavior:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    /* ‚úÖ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ = ÿßÿ±ÿ™ŸÅÿßÿπ ŸÖÿ±ÿ¶Ÿä ÿ≠ŸÇŸäŸÇŸä */
    .app{
      height: calc(var(--vh) * 100);
      display:grid;
      grid-template-rows: 1fr 1fr; /* ‚úÖ 50/50 */
      min-height:0;
    }

    /* ======= Game Area ======= */
    .screenWrap{ min-height:0; }
    .screenFrame{
      height:100%;
      width:100%;
      background: rgba(0,0,0,.18);
      border-bottom: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    #cv{
      width:100%;
      height:100%;
      display:block;
      background:#050b14;
      touch-action:none;
    }

    /* ======= Pad Area ======= */
    .pad{
      min-height:0;
      padding:0; /* ‚úÖ ŸÖŸáŸÖ: ŸÑÿß ŸÜÿÆŸÑŸä padding ŸáŸÜÿß */
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }

    /* ‚úÖ ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ™ŸÖŸÑÿ£ ÿßŸÑŸÜÿµŸÅ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ */
    .padBody{
      height:100%;
      width:100%;
      margin:0;
      max-width:none;

      background: var(--padBase);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 26px;
      box-shadow: 0 16px 60px var(--shadow);

      position:relative;
      overflow:hidden;

      /* ‚úÖ padding ÿØÿßÿÆŸÑŸä (ŸÖÿß Ÿäÿ£ÿ´ÿ± ÿπŸÑŸâ ÿßŸÑÿ™ŸÇÿ≥ŸäŸÖ) */
      padding: 12px;
      padding-bottom: calc(12px + env(safe-area-inset-bottom));

      display:flex;
      flex-direction:column;
      justify-content:space-between;
      min-height:0;
    }

    .padBody:before{
      content:"";
      position:absolute; inset:-45% -20% auto -20%;
      height:80%;
      transform: hint  rotate(-10deg);
      background: rgba(255,255,255,.22);
      pointer-events:none;
    }

    /* ======= Buttons Base ======= */
    .btn{
      border:none;
      cursor:pointer;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
    }
    .btn:active{ transform: translateY(1px); }

    /* ======= Top mini row ======= */
    .padTop{
      z-index:1;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 2px 2px 6px 2px;
    }
    .smallBtn{
      height: calc(56px * var(--padScale));
      padding: 0 calc(18px * var(--padScale));
      border-radius: calc(18px * var(--padScale));
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.14);
      font-weight: 1100;
      color: rgba(0,0,0,.80);
      font-size: calc(15px * var(--padScale));
    }

    /* ======= Main pad grid ======= */
    .padMain{
      z-index:1;
      display:grid;
      grid-template-columns: 1fr 1.35fr 1fr;
      align-items:center;
      gap: 12px;
      padding: 6px 0;
      min-height:0;
    }

    /* Left side (bigger) */
    .sideLeft{
      display:grid;
      justify-items:start;
      gap: 14px;
      padding-left: 4px;
    }
    .pill{
      width: calc(210px * var(--padScale));
      height: calc(78px * var(--padScale));
      border-radius: 999px;
      background: rgba(0,0,0,.10);
      border: 1px solid rgba(0,0,0,.14);
      font-weight: 1200;
      color: rgba(0,0,0,.80);
      font-size: calc(17px * var(--padScale));
    }
    .sub{
      font-size: calc(12px * var(--padScale));
      font-weight: 900;
      color: rgba(0,0,0,.55);
      margin-top: calc(-8px * var(--padScale));
      padding-left: 10px;
    }

    /* Center D-Pad */
    .dpad{
      display:grid;
      justify-items:center;
      gap: calc(14px * var(--padScale));
    }
    .drow{
      display:flex;
      gap: calc(14px * var(--padScale));
      align-items:center;
    }
    .padBtn{
      width: calc(140px * var(--padScale));
      height: calc(120px * var(--padScale));
      border-radius: calc(28px * var(--padScale));
      background: var(--padDark);
      color: rgba(255,255,255,.95);
      font-weight: 1300;
      font-size: calc(34px * var(--padScale));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.06), 0 14px 26px rgba(0,0,0,.22);
    }
    .centerDot{
      width: calc(96px * var(--padScale));
      height: calc(96px * var(--padScale));
      border-radius: calc(24px * var(--padScale));
      background: rgba(0,0,0,.16);
      color: rgba(255,255,255,.78);
      font-weight: 1100;
      font-size: calc(16px * var(--padScale));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.05);
    }

    /* Right side */
    .sideRight{
      display:grid;
      justify-items:end;
      gap: 14px;
      padding-right: 4px;
    }
    .A{
      width: calc(168px * var(--padScale));
      height: calc(168px * var(--padScale));
      border-radius: 999px;
      background: var(--A);
      color: rgba(255,255,255,.95);
      font-weight: 1300;
      font-size: calc(36px * var(--padScale));
      box-shadow: inset 0 0 0 3px rgba(255,255,255,.35), 0 16px 30px rgba(0,0,0,.25);
    }
    .restart{
      width: calc(210px * var(--padScale));
      height: calc(68px * var(--padScale));
      border-radius: calc(18px * var(--padScale));
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(0,0,0,.14);
      font-weight: 1200;
      color: rgba(0,0,0,.80);
      font-size: calc(15px * var(--padScale));
    }

    .padHint{
      z-index:1;
      text-align:center;
      font-size: calc(13px * var(--padScale));
      color: rgba(0,0,0,.55);
      font-weight: 900;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      padding: 0 8px;
    }

    /* ÿπŸÑŸâ ÿßŸÑÿ¥ÿßÿ¥ÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ© (ŸÉŸÖÿ®ŸäŸàÿ™ÿ±/ÿ™ÿßÿ®ŸÑÿ™) ŸÜÿÆŸÑŸä ÿßŸÑŸÑŸàÿ≠ÿ© Ÿàÿ≥ÿ∑ */
    @media (min-width: 900px){
      .pad{
        display:flex;
        justify-content:center;
        align-items:center;
        padding: 10px;
      }
      .padBody{
        max-width: 980px;
        width: min(980px, 100%);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="screenWrap">
      <div class="screenFrame">
        <canvas id="cv"></canvas>
      </div>
    </div>

    <div class="pad">
      <div class="padBody" id="padBody">

        <div class="padTop">
          <button class="btn smallBtn" data-k="SELECT" id="btnSelect">SELECT</button>
          <button class="btn smallBtn" data-k="R" id="btnMenu">MENU</button>
        </div>

        <div class="padMain">
          <div class="sideLeft">
            <div>
              <button class="btn pill" data-k="START" id="btnStart">START</button>
              <div class="sub" id="lblPause">Pause</div>
            </div>
            <div>
              <button class="btn pill" data-k="LANG" id="btnLang">LANG</button>
              <div class="sub" id="lblLang">AR / EN</div>
            </div>
          </div>

          <div class="dpad">
            <button class="btn padBtn" data-k="UP">‚ñ≤</button>
            <div class="drow">
              <button class="btn padBtn" data-k="LEFT">‚óÄ</button>
              <button class="btn centerDot" data-k="CENTER" id="btnHM">HM</button>
              <button class="btn padBtn" data-k="RIGHT">‚ñ∂</button>
            </div>
            <button class="btn padBtn" data-k="DOWN">‚ñº</button>
          </div>

          <div class="sideRight">
            <button class="btn A" data-k="A" id="btnA">A</button>
            <button class="btn restart" data-k="L" id="btnRestart">RESTART</button>
          </div>
        </div>

        <div class="padHint" id="hintLine">
          HM GAME üéÆ ‚Äî Move: D-Pad ‚Ä¢ A Start/Confirm ‚Ä¢ START Pause ‚Ä¢ LANG/SELECT AR/EN ‚Ä¢ RESTART ‚Ä¢ MENU
        </div>

      </div>
    </div>
  </div>
<script>
(() => {
  "use strict";

  // ====== Fix real viewport height (Ÿäÿ´ÿ®ÿ™ 50/50)
  function setRealVH(){
    const h = (window.visualViewport?.height || window.innerHeight);
    document.documentElement.style.setProperty("--vh", (h * 0.01) + "px");
  }
  setRealVH();
  window.addEventListener("resize", setRealVH);
  window.visualViewport?.addEventListener("resize", setRealVH);
  window.visualViewport?.addEventListener("scroll", setRealVH);

  // ====== Auto scale pad buttons based on pad height
  const padBody = document.getElementById("padBody");
  function setPadScale(){
    // ÿßÿ±ÿ™ŸÅÿßÿπ ŸÜÿµŸÅ ÿßŸÑÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ≠ŸÇŸäŸÇŸä (ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ)
    const h = padBody.getBoundingClientRect().height || 360;
    // ŸáÿØŸÅŸÜÿß: ŸÑŸà 400px => scale 1.0 ÿå ŸÑŸà ÿ£ŸÉÿ®ÿ± Ÿäÿ≤ŸäÿØ ÿ™ÿØÿ±Ÿäÿ¨ŸäÿßŸãÿå ŸÑŸà ÿ£ÿµÿ∫ÿ± ŸäŸÇŸÑ
    let scale = h / 400;
    scale = Math.max(0.88, Math.min(1.25, scale)); // ÿ≠ÿØŸàÿØ ÿ¢ŸÖŸÜÿ©
    document.documentElement.style.setProperty("--padScale", scale.toFixed(3));
  }
  setPadScale();
  window.addEventListener("resize", setPadScale);
  window.visualViewport?.addEventListener("resize", setPadScale);

  // ====== Canvas
  const cv = document.getElementById("cv");
  const ctx = cv.getContext("2d", { alpha:false });

  let W=0, H=0, D=1;
  function resizeCanvas(){
    const r=cv.getBoundingClientRect();
    D = Math.max(1, window.devicePixelRatio || 1);
    W = r.width; H = r.height;
    cv.width  = Math.floor(W * D);
    cv.height = Math.floor(H * D);
    ctx.setTransform(D,0,0,D,0,0);
    ctx.imageSmoothingEnabled = false;
  }

  window.addEventListener("contextmenu", e => e.preventDefault(), {passive:false});

  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const now=()=>performance.now();
  const pad2=n=>String(n).padStart(2,"0");
  const fmtTime=(ms)=>{
    const s=Math.floor(ms/1000);
    return `${pad2(Math.floor(s/60))}:${pad2(s%60)}`;
  };

  // ====== Language
  const LANG_KEY="HM_LANG_SNAKE_5050";
  let lang = localStorage.getItem(LANG_KEY) || "en";

  const T={
    ar:{
      title:"HM GAME | ÿ´ÿπÿ®ÿßŸÜ",
      menu:"ÿßÿ∂ÿ∫ÿ∑ ÿ≤ÿ± (A) ŸÑŸÑÿ®ÿØÿ°",
      paused:"‚è∏Ô∏è ŸÖÿ™ŸàŸÇŸÅ ŸÖÿ§ŸÇÿ™ÿßŸã",
      over:"üòµ ÿßŸÜÿ™Ÿáÿ™ ÿßŸÑŸÑÿπÿ®ÿ©",
      score:"ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©", best:"ÿßŸÑÿ£ŸÅÿ∂ŸÑ", time:"ÿßŸÑŸàŸÇÿ™",
      apples:"ÿ™ŸÅÿßÿ≠", len:"ÿßŸÑÿ∑ŸàŸÑ", level:"ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ",
      btnSelect:"ÿ™ÿ≠ÿØŸäÿØ",
      btnMenu:"ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
      btnStart:"ÿßÿ®ÿØÿ£",
      lblPause:"ÿ•ŸäŸÇÿßŸÅ ŸÖÿ§ŸÇÿ™",
      btnLang:"ÿßŸÑŸÑÿ∫ÿ©",
      btnRestart:"ÿ•ÿπÿßÿØÿ© ÿ™ÿ¥ÿ∫ŸäŸÑ",
      hint:"HM GAME üéÆ ‚Äî ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÉ: ÿßŸÑÿ£ÿ≥ŸáŸÖ ‚Ä¢ A: ÿ®ÿØÿ°/ÿ™ÿ£ŸÉŸäÿØ ‚Ä¢ ÿßÿ®ÿØÿ£: ÿ•ŸäŸÇÿßŸÅ ‚Ä¢ ÿßŸÑŸÑÿ∫ÿ©/ÿ™ÿ≠ÿØŸäÿØ: AR/EN ‚Ä¢ ÿ•ÿπÿßÿØÿ© ‚Ä¢ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©",
      resultFoot:"A: ÿ•ÿπÿßÿØÿ©  ‚Ä¢  ÿßŸÑŸÇÿßÿ¶ŸÖÿ©: ŸÇÿßÿ¶ŸÖÿ©  ‚Ä¢  ÿßÿ®ÿØÿ£: ÿ•ÿ∫ŸÑÿßŸÇ"
    },
    en:{
      title:"HM GAME | Snake",
      menu:"Press (A) to start",
      paused:"‚è∏Ô∏è Paused",
      over:"üòµ Game Over",
      score:"Score", best:"Best", time:"Time",
      apples:"Apples", len:"Len", level:"Level",
      btnSelect:"SELECT",
      btnMenu:"MENU",
      btnStart:"START",
      lblPause:"Pause",
      btnLang:"LANG",
      btnRestart:"RESTART",
      hint:"HM GAME üéÆ ‚Äî Move: D-Pad ‚Ä¢ A Start/Confirm ‚Ä¢ START Pause ‚Ä¢ LANG/SELECT AR/EN ‚Ä¢ RESTART ‚Ä¢ MENU",
      resultFoot:"A: Restart   ‚Ä¢   MENU: Menu   ‚Ä¢   START: Close"
    }
  };

  const ui = {
    btnSelect: document.getElementById("btnSelect"),
    btnMenu: document.getElementById("btnMenu"),
    btnStart: document.getElementById("btnStart"),
    lblPause: document.getElementById("lblPause"),
    btnLang: document.getElementById("btnLang"),
    lblLang: document.getElementById("lblLang"),
    btnRestart: document.getElementById("btnRestart"),
    hintLine: document.getElementById("hintLine"),
    btnA: document.getElementById("btnA"),
    btnHM: document.getElementById("btnHM"),
  };

  function applyLang(){
    document.documentElement.lang = lang;
    document.documentElement.dir  = (lang==="ar") ? "rtl" : "ltr";

    ui.btnSelect.textContent = T[lang].btnSelect;
    ui.btnMenu.textContent   = T[lang].btnMenu;
    ui.btnStart.textContent  = T[lang].btnStart;
    ui.lblPause.textContent  = T[lang].lblPause;
    ui.btnLang.textContent   = T[lang].btnLang;
    ui.lblLang.textContent   = "AR / EN";
    ui.btnRestart.textContent= T[lang].btnRestart;
    ui.hintLine.textContent  = T[lang].hint;

    ui.btnA.textContent = "A";
    ui.btnHM.textContent = "HM";
  }

  function toggleLang(){
    lang = (lang==="ar") ? "en" : "ar";
    localStorage.setItem(LANG_KEY, lang);
    applyLang();
  }
  applyLang();

  // ====== Best score
  const BEST_KEY="HM_BEST_SNAKE_5050";
  let best = Number(localStorage.getItem(BEST_KEY) || "0");
  function setBest(v){
    if(v>best){
      best=v;
      localStorage.setItem(BEST_KEY, String(best));
    }
  }

  // ====== Input (fast touch)
  const hold={left:false,right:false,up:false,down:false};
  let wantDir = {x:1,y:0};
  const jp={A:false,START:false,LANG:false,L:false,R:false};
  function clearJP(){ for(const k in jp) jp[k]=false; }

  function setWant(dx,dy){
    if(dx === -Snake.dir.x && dy === -Snake.dir.y) return;
    wantDir = {x:dx, y:dy};
  }

  function onDownKey(k){
    if(k==="UP"){ hold.up=true; setWant(0,-1); }
    if(k==="DOWN"){ hold.down=true; setWant(0,1); }
    if(k==="LEFT"){ hold.left=true; setWant(-1,0); }
    if(k==="RIGHT"){ hold.right=true; setWant(1,0); }

    if(k==="A") jp.A=true;
    if(k==="START") jp.START=true;
    if(k==="LANG" || k==="SELECT") jp.LANG=true;
    if(k==="L") jp.L=true;
    if(k==="R") jp.R=true;
  }
  function onUpKey(k){
    if(k==="UP") hold.up=false;
    if(k==="DOWN") hold.down=false;
    if(k==="LEFT") hold.left=false;
    if(k==="RIGHT") hold.right=false;
  }

  document.querySelectorAll("[data-k]").forEach(btn=>{
    const k=btn.dataset.k;
    btn.addEventListener("pointerdown",(e)=>{
      e.preventDefault();
      btn.setPointerCapture(e.pointerId);
      onDownKey(k);
    }, {passive:false});

    const off=(e)=>{
      onUpKey(k);
      try{ btn.releasePointerCapture(e.pointerId); }catch{}
    };
    btn.addEventListener("pointerup", off);
    btn.addEventListener("pointercancel", off);
    btn.addEventListener("lostpointercapture", off);
  });

  // ====== Draw helpers
  function rr(x,y,w,h,r,fill){
    const rad=Math.min(r,w/2,h/2);
    ctx.beginPath();
    ctx.moveTo(x+rad,y);
    ctx.arcTo(x+w,y,x+w,y+h,rad);
    ctx.arcTo(x+w,y+h,x,y+h,rad);
    ctx.arcTo(x,y+h,x,y,rad);
    ctx.arcTo(x,y,x+w,y,rad);
    ctx.closePath();
    if(fill) ctx.fill(); else ctx.stroke();
  }
  function topBarH(){ return clamp(H*0.060, 26, 40); }
  function ellipsize(text, maxW){
    if(ctx.measureText(text).width <= maxW) return text;
    let s=text;
    while(s.length>3 && ctx.measureText(s+"‚Ä¶").width > maxW) s=s.slice(0,-1);
    return s+"‚Ä¶";
  }

  // ====== State
  const S={
    mode:"menu", // menu | play | pause | result
    score:0, apples:0, len:3, level:1,
    playMs:0, lastRunAt:0,
    resultLines:[]
  };
  function startClock(){ S.lastRunAt = now(); }
  function stopClock(){
    const t=now();
    if(S.lastRunAt) S.playMs += (t - S.lastRunAt);
    S.lastRunAt = 0;
  }
  function timeMs(){
    if(S.mode==="play" && S.lastRunAt) return S.playMs + (now()-S.lastRunAt);
    return S.playMs;
  }

  function drawTopBar(){
    const h=topBarH();
    ctx.fillStyle="rgba(0,0,0,.36)";
    ctx.fillRect(0,0,W,h);

    const fontSize = clamp(h*0.55, 12, 18);
    ctx.font = `${fontSize}px system-ui`;
    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.textBaseline="middle";

    const tm=fmtTime(timeMs());
    let line = `${T[lang].title} | ${T[lang].score} ${S.score} | ${T[lang].best} ${best} | üçé${S.apples} | ${T[lang].len} ${S.len} | ${T[lang].level} ${S.level} | ${tm}`;

    const margin=W*0.02;
    line = ellipsize(line, W - margin*2);

    if(lang==="ar"){ ctx.textAlign="right"; ctx.fillText(line, W-margin, h/2); }
    else { ctx.textAlign="left"; ctx.fillText(line, margin, h/2); }

    return h;
  }

  // ====== Snake (Wrap + ÿ≥ÿ±ÿπÿ© ŸÖŸÜÿßÿ≥ÿ®ÿ© + ÿ™ŸÅÿßÿ≠ÿ© ÿ£ŸÉÿ®ÿ±)
  const Snake = {
    GW: 30, GH: 20,
    cell: 18, ox:0, oy:0,
    snake: [],
    dir: {x:1,y:0},
    food: {x:5,y:5},
    alive: true,
    accMs: 0,
    moveEveryMs: 170, // ‚úÖ ÿ®ÿ∑Ÿäÿ¶ÿ© ŸàŸÖŸÜÿßÿ≥ÿ®ÿ©

    computeGridForScreen(){
      const topH = topBarH();
      const usableW = Math.max(1, W);
      const usableH = Math.max(1, H - topH);
      const GH = 20;
      let GW = Math.round(GH * (usableW / usableH));
      GW = clamp(GW, 26, 38);
      this.GH = GH;
      this.GW = GW;
    },

    layout(){
      const topH = topBarH();
      const usableW = W;
      const usableH = (H - topH);

      this.cell = Math.floor(Math.min(usableW/this.GW, usableH/this.GH));
      this.cell = clamp(this.cell, 14, 80);

      this.ox = Math.floor((W - this.cell*this.GW)/2);
      this.oy = Math.floor(topH + ((H-topH) - this.cell*this.GH)/2);
    },

    placeFood(){
      for(let i=0;i<5000;i++){
        const fx=(Math.random()*this.GW)|0;
        const fy=(Math.random()*this.GH)|0;
        if(!this.snake.some(p=>p.x===fx && p.y===fy)){
          this.food={x:fx,y:fy};
          return;
        }
      }
      this.food={x:1,y:1};
    },

    init(){
      this.computeGridForScreen();
      this.layout();

      S.score=0; S.apples=0; S.level=1; S.playMs=0;
      this.dir={x:1,y:0};
      wantDir={x:1,y:0};

      const sy=(this.GH/2)|0;
      this.snake=[{x:7,y:sy},{x:6,y:sy},{x:5,y:sy}];
      S.len=this.snake.length;

      this.alive=true;
      this.accMs=0;
      this.moveEveryMs=170;

      this.placeFood();
    },

    over(){
      this.alive=false;
      stopClock();
      setBest(S.score);

      S.mode="result";
      S.resultLines=[
        `${T[lang].score}: ${S.score}`,
        `${T[lang].apples}: ${S.apples}`,
        `${T[lang].len}: ${S.len}`,
        `${T[lang].time}: ${fmtTime(timeMs())}`
      ];
    },

    step(){
      if(!this.alive) return;

      this.dir = {x: wantDir.x, y: wantDir.y};

      const h=this.snake[0];
      let nx=h.x+this.dir.x;
      let ny=h.y+this.dir.y;

      // ‚úÖ Wrap walls
      if(nx < 0) nx = this.GW - 1;
      if(nx >= this.GW) nx = 0;
      if(ny < 0) ny = this.GH - 1;
      if(ny >= this.GH) ny = 0;

      // ‚úÖ Game over ŸÅŸÇÿ∑ ÿπŸÜÿØ ÿßŸÑÿßÿµÿ∑ÿØÿßŸÖ ÿ®ŸÜŸÅÿ≥Ÿá
      if(this.snake.some((p,i)=>i>0 && p.x===nx && p.y===ny)){
        this.over(); return;
      }

      this.snake.unshift({x:nx,y:ny});

      if(nx===this.food.x && ny===this.food.y){
        S.score += 10;
        S.apples++;
        S.len=this.snake.length;

        S.level = 1 + Math.floor(S.apples/6);
        this.moveEveryMs = clamp(170 - (S.level-1)*8, 120, 170);

        this.placeFood();
        setBest(S.score);
      }else{
        this.snake.pop();
        S.len=this.snake.length;
      }
    },

    update(dtMs){
      this.layout();

      if(hold.up) setWant(0,-1);
      else if(hold.down) setWant(0,1);
      else if(hold.left) setWant(-1,0);
      else if(hold.right) setWant(1,0);

      this.accMs += dtMs;
      while(this.accMs >= this.moveEveryMs){
        this.accMs -= this.moveEveryMs;
        this.step();
        if(S.mode!=="play") break;
      }
    },

    draw(){
      this.layout();

      ctx.fillStyle="#061025";
      ctx.fillRect(0,0,W,H);

      // board
      ctx.fillStyle="rgba(255,255,255,.05)";
      rr(this.ox-4, this.oy-4, this.cell*this.GW+8, this.cell*this.GH+8, 18, true);

      // ‚úÖ Apple bigger
      const fx=this.ox+this.food.x*this.cell+this.cell/2;
      const fy=this.oy+this.food.y*this.cell+this.cell/2;
      ctx.fillStyle="rgba(255,211,79,.95)";
      ctx.beginPath();
      ctx.arc(fx, fy, this.cell*0.36, 0, Math.PI*2);
      ctx.fill();

      // snake
      for(let i=this.snake.length-1;i>=0;i--){
        const p=this.snake[i];
        const x=this.ox+p.x*this.cell;
        const y=this.oy+p.y*this.cell;
        const inset=Math.max(2, Math.floor(this.cell*0.10));
        const r=Math.floor(this.cell*0.28);

        if(i===0){
          ctx.fillStyle="rgba(78,161,255,.95)";
          rr(x+inset,y+inset,this.cell-inset*2,this.cell-inset*2,r,true);

          const ex1=x+this.cell*0.38, ex2=x+this.cell*0.62;
          const ey=y+this.cell*0.43;
          ctx.fillStyle="rgba(255,255,255,.92)";
          ctx.beginPath(); ctx.arc(ex1,ey, Math.max(2,this.cell*0.07), 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(ex2,ey, Math.max(2,this.cell*0.07), 0, Math.PI*2); ctx.fill();
          ctx.fillStyle="rgba(0,0,0,.65)";
          ctx.beginPath(); ctx.arc(ex1,ey, Math.max(1.3,this.cell*0.035), 0, Math.PI*2); ctx.fill();
          ctx.beginPath(); ctx.arc(ex2,ey, Math.max(1.3,this.cell*0.035), 0, Math.PI*2); ctx.fill();
        }else{
          ctx.fillStyle="rgba(78,161,255,.72)";
          rr(x+inset,y+inset,this.cell-inset*2,this.cell-inset*2,r,true);
        }
      }
    }
  };

  // ====== Screens
  function drawMenu(){
    ctx.fillStyle="#050b14";
    ctx.fillRect(0,0,W,H);
    drawTopBar();

    ctx.textAlign="center";
    ctx.textBaseline="middle";

    const titleSize = clamp(W*0.11, 28, 56);
    const hintSize  = clamp(W*0.045, 14, 22);

    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.font=`${titleSize}px system-ui`;
    ctx.fillText("HM GAME", W/2, H*0.44);

    ctx.fillStyle="rgba(255,255,255,.72)";
    ctx.font=`${hintSize}px system-ui`;
    ctx.fillText(T[lang].menu, W/2, H*0.60);
  }

  function drawPause(){
    Snake.draw();
    drawTopBar();

    ctx.fillStyle="rgba(0,0,0,.28)";
    const w=W*0.66, h=H*0.16;
    rr((W-w)/2, H*0.42, w, h, 18, true);

    ctx.fillStyle="rgba(255,255,255,.92)";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.font=`${clamp(W*0.060, 18, 30)}px system-ui`;
    ctx.fillText(T[lang].paused, W/2, H*0.50);
  }

  function drawResult(){
    Snake.draw();
    drawTopBar();

    ctx.fillStyle="rgba(0,0,0,.42)";
    ctx.fillRect(0,0,W,H);

    const w=W*0.86, h=H*0.50;
    const x=(W-w)/2, y=(H-h)/2;

    ctx.fillStyle="rgba(16,22,36,.92)";
    rr(x,y,w,h,18,true);
    ctx.strokeStyle="rgba(255,255,255,.16)";
    ctx.lineWidth=2;
    rr(x,y,w,h,18,false);

    const titleSize=clamp(W*0.065, 18, 34);
    const lineSize =clamp(W*0.052, 14, 26);
    const footSize =clamp(W*0.044, 12, 20);

    ctx.textAlign="center";
    ctx.fillStyle="rgba(255,255,255,.95)";
    ctx.font=`${titleSize}px system-ui`;
    ctx.fillText(T[lang].over, W/2, y + h*0.22);

    ctx.fillStyle="rgba(255,255,255,.82)";
    ctx.font=`${lineSize}px system-ui`;
    let yy = y + h*0.40;
    for(const line of S.resultLines){
      ctx.fillText(line, W/2, yy);
      yy += lineSize*1.35;
    }

    ctx.fillStyle="rgba(255,255,255,.85)";
    ctx.font=`${footSize}px system-ui`;
    ctx.fillText(T[lang].resultFoot, W/2, y + h*0.88);
  }

  // ====== Flow
  function goMenu(){
    S.mode="menu";
    S.score=0; S.apples=0; S.len=3; S.level=1;
    S.playMs=0; S.lastRunAt=0;
  }
  function startPlay(){
    S.mode="play";
    S.playMs=0;
    Snake.init();
    startClock();
  }
  function togglePause(){
    if(S.mode==="play"){ S.mode="pause"; stopClock(); }
    else if(S.mode==="pause"){ S.mode="play"; startClock(); }
  }

  let last=now();
  function loop(){
    setRealVH();
    setPadScale();
    resizeCanvas();

    const t=now();
    const dtMs = clamp(t-last, 0, 50);
    last=t;

    if(jp.LANG){ toggleLang(); jp.LANG=false; }
    if(jp.R){ goMenu(); jp.R=false; }
    if(jp.L){ startPlay(); jp.L=false; }

    if(S.mode==="menu"){
      if(jp.A){ startPlay(); jp.A=false; }
      drawMenu();
      clearJP();
      requestAnimationFrame(loop);
      return;
    }

    if(jp.START && (S.mode==="play" || S.mode==="pause")){
      togglePause();
      jp.START=false;
    }

    if(S.mode==="result"){
      if(jp.A){ startPlay(); jp.A=false; }
      if(jp.START){ goMenu(); jp.START=false; }
      drawResult();
      clearJP();
      requestAnimationFrame(loop);
      return;
    }

    if(S.mode==="pause"){
      drawPause();
      clearJP();
      requestAnimationFrame(loop);
      return;
    }

    Snake.update(dtMs);
    Snake.draw();
    drawTopBar();

    clearJP();
    requestAnimationFrame(loop);
  }

  goMenu();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>